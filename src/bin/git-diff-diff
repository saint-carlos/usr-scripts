#!/bin/bash

PROGRAM=$(basename $0)
DESCRIPTION="diff between diffs"
PARAMS="revision-range revision-range"
OPTIONS="[-h]"

usage()
{
	[ $1 -ne 0 ] && exec >&2

	cat << EOF
$PROGRAM - $DESCRIPTION
usage:
$PROGRAM $OPTIONS $PARAMS
revision-range can be a single commit.

options:
-h	help: show this help message and exit.

exit status:
255	bad arguments
otherwise same as vimdiff
EOF
    exit $1
}

if [ "$1" = "-h" ]; then
	usage 0
fi
[ $# -ge 2 ] || usage 255
ARGS=( "$@" )
LIDX=$(($# - 2))
RIDX=$(($# - 1))
LEFT="${ARGS[LIDX]}"
RIGHT="${ARGS[RIDX]}"
unset ARGS[LIDX]
unset ARGS[RIDX]

case $LEFT in
	*..*) LEFT_CMD=diff ;;
	*) LEFT_CMD=show
esac
case $RIGHT in
	*..*) RIGHT_CMD=diff ;;
	*) RIGHT_CMD=show ;;
esac
exec vimdiff -c 'set diffexpr=GitDiffDiff()' \
	<(git $LEFT_CMD "${ARGS[@]}" "$LEFT") \
	<(git $RIGHT_CMD "${ARGS[@]}" "$RIGHT")
