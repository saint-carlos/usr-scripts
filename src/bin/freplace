#!/bin/bash

PROGRAM=`basename $0`
DESCRIPTION="in-place text replace"
PARAMS="regexp-to-replace replacement-text file-name..."
OPTIONS="[-h]"

usage()
{
	[ $1 -ne 0 ] && exec >&2

	cat << EOF
$PROGRAM - $DESCRIPTION
usage:
$PROGRAM $OPTIONS $PARAMS

options:
-h	help: show this help message and exit.

exit status:
1	arguments are bad
255	could not find a suitable separator
otherwise it is the exit status of 'sed'

EOF

    exit $1
}

replace()
{
    REGEX="$1"
    shift
    REPLACEMENT="$1"
    shift
    for S in '/' ':' '|' ','; do
        echo "${REGEX}${REPLACEMENT}" | grep "$S" >/dev/null 2>/dev/null
        if [ $? -ne 0 ]; then # the SEPARATOR is not in the regex
            SEPARATOR=$S
            break;
        fi
    done
    [ -n "$SEPARATOR" ] || return 255
    sed -i "s${SEPARATOR}${REGEX}${SEPARATOR}${REPLACEMENT}${SEPARATOR}g" "$@"
}

while getopts h option; do
    case $option in
        h) usage 0 ;;
        \?) usage 1 ;;
    esac
done
shift `expr $OPTIND - 1`

case $# in
[0-2]) usage 1 ;;
*) replace "$@" ;;
esac

