#!/bin/bash

#!/bin/bash

PROGRAM=$(basename $0)
DESCRIPTION="diff between logs"
PARAMS="revision-range revision-range"
OPTIONS="[-h]"

usage()
{
	[ $1 -ne 0 ] && exec >&2

	cat << EOF
$PROGRAM - $DESCRIPTION
usage:
$PROGRAM $OPTIONS $PARAMS
revision-range can be a single commit.

options:
-h	help: show this help message and exit.

exit status:
254	arguments have no common base
255	bad arguments
otherwise same as vimdiff
EOF
    exit $1
}

if [ "$1" = "-h" ]; then
	usage 0
fi
[ $# -ge 2 ] || usage 255
ARGS=( "$@" )
LIDX=$(($# - 2))
RIDX=$(($# - 1))
LEFT="${ARGS[LIDX]}"
RIGHT="${ARGS[RIDX]}"
unset ARGS[LIDX]
unset ARGS[RIDX]

[ $# -ge 2 ] || usage 255
ARGS=( "$@" )
LIDX=$(($# - 2))
RIDX=$(($# - 1))
LEFT="${ARGS[LIDX]}"
RIGHT="${ARGS[RIDX]}"
unset ARGS[LIDX]
unset ARGS[RIDX]
LEFT_BASE=0
RIGHT_BASE=0
[[ "$LEFT" =~ \.\. ]] && LEFT_BASE=1
[[ "$RIGHT" =~ \.\. ]] && RIGHT_BASE=1
[ $LEFT_BASE -eq $RIGHT_BASE ] || usage 255

if [ $LEFT_BASE -ne 1 ] ; then
	BASE=$(git merge-base "$LEFT" "$RIGHT")
	if [ $? -ne 0 ] ; then
		errcho "'$LEFT' and '$RIGHT_BASE' don't seem to have common base!"
		exit 254
	fi
	LEFT_BASE="${BASE}^.."
	RIGHT_BASE="${BASE}^.."
else
	LEFT_BASE=""
	RIGHT_BASE=""
fi

exec vimdiff -c 'set diffexpr=GitDiffLog()' \
	<(git log "${ARGS[@]}" "${LEFT_BASE}${LEFT}") \
	<(git log "${ARGS[@]}" "${RIGHT_BASE}${RIGHT}")
